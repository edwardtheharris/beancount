
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>beancount.plugins.book_conversions &#8212; Beancount 2.2.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for beancount.plugins.book_conversions</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;A plugin that automatically converts postings at price to postings held at</span>
<span class="sd">cost, applying an automatic booking algorithm in assigning the cost bases and</span>
<span class="sd">matching lots.</span>

<span class="sd">This plugin restricts itself to applying these transformations within a</span>
<span class="sd">particular account, which you provide. For each of those accounts, it also</span>
<span class="sd">requires a corresponding Income account to book the profit/loss of reducing</span>
<span class="sd">lots (i.e., sales):</span>

<span class="sd">  plugin &quot;beancount.plugins.book_conversions&quot; &quot;Assets:Bitcoin,Income:Bitcoin&quot;</span>

<span class="sd">Then, simply input the transactions with price conversion. We use &quot;Bitcoins&quot; in</span>
<span class="sd">this example, converting Bitcoin purchases that were carried out as currency</span>
<span class="sd">into maintaining these with cost basis, for tax reporting purposes:</span>

<span class="sd">  2015-09-04 * &quot;Buy some bitcoins&quot;</span>
<span class="sd">    Assets:Bank          -1000.00 USD</span>
<span class="sd">    Assets:Bitcoin       4.333507 BTC @ 230.76 USD</span>

<span class="sd">  2015-09-05 * &quot;Buy some more bitcoins at a different price&quot;</span>
<span class="sd">    Assets:Bank          -1000.00 USD</span>
<span class="sd">    Assets:Bitcoin       4.345747 BTC @ 230.11 USD</span>

<span class="sd">  2015-09-20 * &quot;Use (sell) some bitcoins&quot;</span>
<span class="sd">    Assets:Bitcoin       -6.000000 BTC @ 230.50 USD</span>
<span class="sd">    Expenses:Something</span>

<span class="sd">The result is that cost bases are inserted on augmenting lots:</span>

<span class="sd">  2015-09-04 * &quot;Buy some bitcoins&quot;</span>
<span class="sd">    Assets:Bitcoin  4.333507 BTC {230.76 USD} @ 230.76 USD</span>
<span class="sd">    Assets:Bank     -1000.00 USD</span>

<span class="sd">  2015-09-05 * &quot;Buy some more bitcoins at a different price&quot;</span>
<span class="sd">    Assets:Bitcoin  4.345747 BTC {230.11 USD} @ 230.11 USD</span>
<span class="sd">    Assets:Bank     -1000.00 USD</span>

<span class="sd">While on reducing lots, matching FIFO lots are automatically found and the</span>
<span class="sd">corresponding cost basis added:</span>

<span class="sd">  2015-09-20 * &quot;Use (sell) some bitcoins&quot;</span>
<span class="sd">    Assets:Bitcoin          -4.333507 BTC {230.76 USD} @ 230.50 USD</span>
<span class="sd">    Assets:Bitcoin          -1.666493 BTC {230.11 USD} @ 230.50 USD</span>
<span class="sd">    Income:Bitcoin         0.47677955 USD</span>
<span class="sd">    Expenses:Something  1383.00000000 USD</span>

<span class="sd">Note that multiple lots were required to fulfill the sale quantity here. As in</span>
<span class="sd">this example, this may result in multiple lots being created for a single one.</span>

<span class="sd">Finally, Beancount will eventually support booking methods built-in, but this is</span>
<span class="sd">a quick method that shows how to hack your own booking method via</span>
<span class="sd">transformations of the postings that run in in a plugin.</span>

<span class="sd">Implementation notes:</span>

<span class="sd">- This code uses the FIFO method only for now. However, it would be very easy to</span>
<span class="sd">  customize it to provide other booking methods, e.g. LIFO, or otherwise. This</span>
<span class="sd">  will be added eventually, and I&#39;m hoping to reuse the same inventory</span>
<span class="sd">  abstractions that will be used to implement the fallback booking methods from</span>
<span class="sd">  the booking proposal review (http://furius.ca/beancount/doc/proposal-booking).</span>

<span class="sd">- Instead of keeping a list of (Position, Transaction) pairs for the pending</span>
<span class="sd">  FIFO lots, we really ought to use a beancount.core.inventory.Inventory</span>
<span class="sd">  instance. However, the class does not contain sufficient data to carry out</span>
<span class="sd">  FIFO booking at the moment. A newer implementation, living in the &quot;booking&quot;</span>
<span class="sd">  branch, does, and will be used in the future.</span>

<span class="sd">- This code assumes that a positive number of units is an augmenting lot and a</span>
<span class="sd">  reducing one has a negative number of units, though we never call them that</span>
<span class="sd">  way on purpose (to eventually allow this code to handle short positions). This</span>
<span class="sd">  is not strictly true; however, we would need an Inventory in order to figrue</span>
<span class="sd">  this out. This will be done in the future and is not difficult to do.</span>


<span class="sd">IMPORTANT:</span>

<span class="sd">  This plugin was developed before the booking methods (FIFO, LIFO, and others)</span>
<span class="sd">  were fully implemented in Beancount. It was built to answer a question on the</span>
<span class="sd">  mailing-list about FIFO booking. You probably don&#39;t need to use them anymore.</span>
<span class="sd">  Always prefer to use the native syntax instead of this.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright (C) 2015-2016  Martin Blais&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;GNU GPLv2&quot;</span>
<span class="n">__plugins__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;book_price_conversions_plugin&#39;</span><span class="p">,)</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">beancount.core.number</span> <span class="k">import</span> <span class="n">ZERO</span>
<span class="kn">from</span> <span class="nn">beancount.core</span> <span class="k">import</span> <span class="n">amount</span>
<span class="kn">from</span> <span class="nn">beancount.core</span> <span class="k">import</span> <span class="n">position</span>
<span class="kn">from</span> <span class="nn">beancount.core</span> <span class="k">import</span> <span class="n">inventory</span>
<span class="kn">from</span> <span class="nn">beancount.core</span> <span class="k">import</span> <span class="n">account</span>
<span class="kn">from</span> <span class="nn">beancount.core</span> <span class="k">import</span> <span class="n">data</span>
<span class="kn">from</span> <span class="nn">beancount</span> <span class="k">import</span> <span class="n">loader</span>
<span class="kn">from</span> <span class="nn">beancount.reports</span> <span class="k">import</span> <span class="n">table</span>
<span class="kn">from</span> <span class="nn">beancount.utils</span> <span class="k">import</span> <span class="n">version</span>


<span class="c1"># The name of the metadata field used to link matched postings.</span>
<span class="n">META</span> <span class="o">=</span> <span class="s1">&#39;trades&#39;</span>


<span class="c1"># An error in the configuration for this plugin.</span>
<span class="n">ConfigError</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;ConfigError&#39;</span><span class="p">,</span> <span class="s1">&#39;source message entry&#39;</span><span class="p">)</span>

<span class="c1"># A failure to find a matching lot.</span>
<span class="n">BookConversionError</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;BookConversionError&#39;</span><span class="p">,</span> <span class="s1">&#39;source message entry&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="is_matching"><a class="viewcode-back" href="../../../modules/plugins/beancount.plugins.book_conversions.html#beancount.plugins.book_conversions.is_matching">[docs]</a><span class="k">def</span> <span class="nf">is_matching</span><span class="p">(</span><span class="n">posting</span><span class="p">,</span> <span class="n">account</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot;Identify if the given posting is one to be booked.</span>

<span class="sd">    Args:</span>
<span class="sd">      posting: An instance of a Posting.</span>
<span class="sd">      account: The account name configured.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A boolean, true if this posting is one that we should be adding a cost to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">account</span> <span class="o">==</span> <span class="n">account</span> <span class="ow">and</span>
            <span class="n">posting</span><span class="o">.</span><span class="n">cost</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="n">posting</span><span class="o">.</span><span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="augment_inventory"><a class="viewcode-back" href="../../../modules/plugins/beancount.plugins.book_conversions.html#beancount.plugins.book_conversions.augment_inventory">[docs]</a><span class="k">def</span> <span class="nf">augment_inventory</span><span class="p">(</span><span class="n">pending_lots</span><span class="p">,</span> <span class="n">posting</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">eindex</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add the lots from the given posting to the running inventory.</span>

<span class="sd">    Args:</span>
<span class="sd">      pending_lots: A list of pending ([number], Posting, Transaction) to be matched.</span>
<span class="sd">        The number is modified in-place, destructively.</span>
<span class="sd">      posting: The posting whose position is to be added.</span>
<span class="sd">      entry: The parent transaction.</span>
<span class="sd">      eindex: The index of the parent transaction housing this posting.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A new posting with cost basis inserted to be added to a transformed transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span>
    <span class="n">new_posting</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
        <span class="n">units</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="p">),</span>
        <span class="n">cost</span><span class="o">=</span><span class="n">position</span><span class="o">.</span><span class="n">Cost</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                           <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
                           <span class="n">entry</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                           <span class="kc">None</span><span class="p">))</span>
    <span class="n">pending_lots</span><span class="o">.</span><span class="n">append</span><span class="p">(([</span><span class="n">number</span><span class="p">],</span> <span class="n">new_posting</span><span class="p">,</span> <span class="n">eindex</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">new_posting</span></div>


<div class="viewcode-block" id="reduce_inventory"><a class="viewcode-back" href="../../../modules/plugins/beancount.plugins.book_conversions.html#beancount.plugins.book_conversions.reduce_inventory">[docs]</a><span class="k">def</span> <span class="nf">reduce_inventory</span><span class="p">(</span><span class="n">pending_lots</span><span class="p">,</span> <span class="n">posting</span><span class="p">,</span> <span class="n">eindex</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Match a reducing posting against a list of lots (using FIFO order).</span>

<span class="sd">    Args:</span>
<span class="sd">      pending_lots: A list of pending ([number], Posting, Transaction) to be matched.</span>
<span class="sd">        The number is modified in-place, destructively.</span>
<span class="sd">      posting: The posting whose position is to be added.</span>
<span class="sd">      eindex: The index of the parent transaction housing this posting.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A tuple of</span>
<span class="sd">        postings: A list of new Posting instances corresponding to the given</span>
<span class="sd">          posting, that were booked to the current list of lots.</span>
<span class="sd">        matches: A list of pairs of (augmenting-posting, reducing-posting).</span>
<span class="sd">        pnl: A Decimal, the P/L incurred in reducing these lots.</span>
<span class="sd">        errors: A list of new errors generated in reducing these lots.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_postings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pnl</span> <span class="o">=</span> <span class="n">ZERO</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">match_number</span> <span class="o">=</span> <span class="o">-</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span>
    <span class="n">match_currency</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span>
    <span class="n">cost_currency</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">currency</span>
    <span class="k">while</span> <span class="n">match_number</span> <span class="o">!=</span> <span class="n">ZERO</span><span class="p">:</span>

        <span class="c1"># Find the first lot with matching currency.</span>
        <span class="k">for</span> <span class="n">fnumber</span><span class="p">,</span> <span class="n">fposting</span><span class="p">,</span> <span class="n">findex</span> <span class="ow">in</span> <span class="n">pending_lots</span><span class="p">:</span>
            <span class="n">funits</span> <span class="o">=</span> <span class="n">fposting</span><span class="o">.</span><span class="n">units</span>
            <span class="n">fcost</span> <span class="o">=</span> <span class="n">fposting</span><span class="o">.</span><span class="n">cost</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">funits</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="n">match_currency</span> <span class="ow">and</span>
                <span class="n">fcost</span> <span class="ow">and</span> <span class="n">fcost</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="n">cost_currency</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">fnumber</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ZERO</span><span class="p">,</span> <span class="s2">&quot;Internal error, zero lot&quot;</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">BookConversionError</span><span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span>
                          <span class="s2">&quot;Could not match position </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">posting</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">break</span>

        <span class="c1"># Reduce the pending lots.</span>
        <span class="n">number</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">match_number</span><span class="p">,</span> <span class="n">fnumber</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">fcost</span>
        <span class="n">match_number</span> <span class="o">-=</span> <span class="n">number</span>
        <span class="n">fnumber</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">number</span>
        <span class="k">if</span> <span class="n">fnumber</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ZERO</span><span class="p">:</span>
            <span class="n">pending_lots</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Add a corresponding posting.</span>
        <span class="n">rposting</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
            <span class="n">units</span><span class="o">=</span><span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="o">-</span><span class="n">number</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">),</span>
            <span class="n">cost</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">cost</span><span class="p">))</span>
        <span class="n">new_postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rposting</span><span class="p">)</span>

        <span class="c1"># Update the P/L.</span>
        <span class="n">pnl</span> <span class="o">+=</span> <span class="n">number</span> <span class="o">*</span> <span class="p">(</span><span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">number</span> <span class="o">-</span> <span class="n">cost</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>

        <span class="c1"># Add to the list of matches.</span>
        <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">findex</span><span class="p">,</span> <span class="n">fposting</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">eindex</span><span class="p">,</span> <span class="n">rposting</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">new_postings</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">pnl</span><span class="p">,</span> <span class="n">errors</span></div>


<div class="viewcode-block" id="link_entries_with_metadata"><a class="viewcode-back" href="../../../modules/plugins/beancount.plugins.book_conversions.html#beancount.plugins.book_conversions.link_entries_with_metadata">[docs]</a><span class="k">def</span> <span class="nf">link_entries_with_metadata</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">all_matches</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Modify the entries in-place to add matching links to postings.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: The list of entries to modify.</span>
<span class="sd">      all_matches: A list of pairs of (augmenting-posting, reducing-posting).</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of pairs of (index, Posting) for the new (augmenting, reducing)</span>
<span class="sd">      annotated postings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Allocate trade names and compute a map of posting to trade names.</span>
    <span class="n">link_map</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">aug_index</span><span class="p">,</span> <span class="n">aug_posting</span><span class="p">),</span> <span class="p">(</span><span class="n">red_index</span><span class="p">,</span> <span class="n">red_posting</span><span class="p">)</span> <span class="ow">in</span> <span class="n">all_matches</span><span class="p">:</span>
        <span class="n">link</span> <span class="o">=</span> <span class="s1">&#39;trade-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">link_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">aug_posting</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
        <span class="n">link_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">red_posting</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>

    <span class="c1"># Modify the postings.</span>
    <span class="n">postings_repl_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">posting</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">):</span>
                <span class="n">links</span> <span class="o">=</span> <span class="n">link_map</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">posting</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">links</span><span class="p">:</span>
                    <span class="n">new_posting</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="n">posting</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                    <span class="n">new_posting</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="n">META</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_posting</span>
                    <span class="n">postings_repl_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">posting</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new_posting</span>

    <span class="c1"># Just a sanity check.</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">link_map</span><span class="p">,</span> <span class="s2">&quot;Internal error: not all matches found.&quot;</span>

    <span class="c1"># Return a list of the modified postings (mapping the old matches to the</span>
    <span class="c1"># newly created ones).</span>
    <span class="k">return</span> <span class="p">[((</span><span class="n">aug_index</span><span class="p">,</span> <span class="n">postings_repl_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">aug_posting</span><span class="p">)]),</span>
             <span class="p">(</span><span class="n">red_index</span><span class="p">,</span> <span class="n">postings_repl_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">red_posting</span><span class="p">)]))</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">aug_index</span><span class="p">,</span> <span class="n">aug_posting</span><span class="p">),</span> <span class="p">(</span><span class="n">red_index</span><span class="p">,</span> <span class="n">red_posting</span><span class="p">)</span> <span class="ow">in</span> <span class="n">all_matches</span><span class="p">]</span></div>


<div class="viewcode-block" id="book_price_conversions"><a class="viewcode-back" href="../../../modules/plugins/beancount.plugins.book_conversions.html#beancount.plugins.book_conversions.book_price_conversions">[docs]</a><span class="k">def</span> <span class="nf">book_price_conversions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">assets_account</span><span class="p">,</span> <span class="n">income_account</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rewrite transactions to insert cost basis according to a booking method.</span>

<span class="sd">    See module docstring for full details.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of entry instances.</span>
<span class="sd">      assets_account: An account string, the name of the account to process.</span>
<span class="sd">      income_account: An account string, the name of the account to use for booking</span>
<span class="sd">        realized profit/loss.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A tuple of</span>
<span class="sd">        entries: A list of new, modified entries.</span>
<span class="sd">        errors: A list of errors generated by this plugin.</span>
<span class="sd">        matches: A list of (number, augmenting-posting, reducing-postings) for all</span>
<span class="sd">          matched lots.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Pairs of (Position, Transaction) instances used to match augmenting</span>
    <span class="c1"># entries with reducing ones.</span>
    <span class="n">pending_lots</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># A list of pairs of matching (augmenting, reducing) postings.</span>
    <span class="n">all_matches</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">new_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">eindex</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>

        <span class="c1"># Figure out if this transaction has postings in Bitcoins without a cost.</span>
        <span class="c1"># The purpose of this plugin is to fixup those.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_matching</span><span class="p">(</span><span class="n">posting</span><span class="p">,</span> <span class="n">assets_account</span><span class="p">)</span>
                                                       <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">):</span>

            <span class="c1"># Segregate the reducing lots, augmenting lots and other lots.</span>
            <span class="n">augmenting</span><span class="p">,</span> <span class="n">reducing</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pindex</span><span class="p">,</span> <span class="n">posting</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">is_matching</span><span class="p">(</span><span class="n">posting</span><span class="p">,</span> <span class="n">assets_account</span><span class="p">):</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">augmenting</span> <span class="k">if</span> <span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="n">ZERO</span> <span class="k">else</span> <span class="n">reducing</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">other</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>

            <span class="c1"># We will create a replacement list of postings with costs filled</span>
            <span class="c1"># in, possibly more than the original list, to account for the</span>
            <span class="c1"># different lots.</span>
            <span class="n">new_postings</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Convert all the augmenting postings to cost basis.</span>
            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">augmenting</span><span class="p">:</span>
                <span class="n">new_postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">augment_inventory</span><span class="p">(</span><span class="n">pending_lots</span><span class="p">,</span> <span class="n">posting</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">eindex</span><span class="p">))</span>

            <span class="c1"># Then process reducing postings.</span>
            <span class="k">if</span> <span class="n">reducing</span><span class="p">:</span>
                <span class="c1"># Process all the reducing postings, booking them to matching lots.</span>
                <span class="n">pnl</span> <span class="o">=</span> <span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">reducing</span><span class="p">:</span>
                    <span class="n">rpostings</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">posting_pnl</span><span class="p">,</span> <span class="n">new_errors</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">reduce_inventory</span><span class="p">(</span><span class="n">pending_lots</span><span class="p">,</span> <span class="n">posting</span><span class="p">,</span> <span class="n">eindex</span><span class="p">))</span>
                    <span class="n">new_postings</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rpostings</span><span class="p">)</span>
                    <span class="n">all_matches</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_errors</span><span class="p">)</span>
                    <span class="n">pnl</span><span class="o">.</span><span class="n">add_amount</span><span class="p">(</span><span class="n">amount</span><span class="o">.</span><span class="n">Amount</span><span class="p">(</span><span class="n">posting_pnl</span><span class="p">,</span> <span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">currency</span><span class="p">))</span>

                <span class="c1"># If some reducing lots were seen in this transaction, insert an</span>
                <span class="c1"># Income leg to absorb the P/L. We need to do this for each currency</span>
                <span class="c1"># which incurred P/L.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pnl</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">pnl</span><span class="p">:</span>
                        <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">new_metadata</span><span class="p">(</span><span class="s1">&#39;&lt;book_conversions&gt;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">new_postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">Posting</span><span class="p">(</span><span class="n">income_account</span><span class="p">,</span>
                                         <span class="o">-</span><span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                         <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">meta</span><span class="p">))</span>

            <span class="c1"># Third, add back all the other unrelated legs in.</span>
            <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">other</span><span class="p">:</span>
                <span class="n">new_postings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">posting</span><span class="p">)</span>

            <span class="c1"># Create a replacement entry.</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">postings</span><span class="o">=</span><span class="n">new_postings</span><span class="p">)</span>

        <span class="n">new_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="c1"># Add matching metadata to all matching postings.</span>
    <span class="n">mod_matches</span> <span class="o">=</span> <span class="n">link_entries_with_metadata</span><span class="p">(</span><span class="n">new_entries</span><span class="p">,</span> <span class="n">all_matches</span><span class="p">)</span>

    <span class="c1"># Resolve the indexes to their possibly modified Transaction instances.</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[(</span><span class="n">data</span><span class="o">.</span><span class="n">TxnPosting</span><span class="p">(</span><span class="n">new_entries</span><span class="p">[</span><span class="n">aug_index</span><span class="p">],</span> <span class="n">aug_posting</span><span class="p">),</span>
                <span class="n">data</span><span class="o">.</span><span class="n">TxnPosting</span><span class="p">(</span><span class="n">new_entries</span><span class="p">[</span><span class="n">red_index</span><span class="p">],</span> <span class="n">red_posting</span><span class="p">))</span>
               <span class="k">for</span> <span class="p">(</span><span class="n">aug_index</span><span class="p">,</span> <span class="n">aug_posting</span><span class="p">),</span> <span class="p">(</span><span class="n">red_index</span><span class="p">,</span> <span class="n">red_posting</span><span class="p">)</span> <span class="ow">in</span> <span class="n">mod_matches</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">matches</span></div>


<div class="viewcode-block" id="extract_trades"><a class="viewcode-back" href="../../../modules/plugins/beancount.plugins.book_conversions.html#beancount.plugins.book_conversions.extract_trades">[docs]</a><span class="k">def</span> <span class="nf">extract_trades</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find all the matching trades from the metadata attached to postings.</span>

<span class="sd">    This inspects all the postings and pairs them up using the special metadata</span>
<span class="sd">    field that was added by this plugin when booking matching lots, and returns</span>
<span class="sd">    pairs of those postings.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: The list of directives to extract from.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A list of (number, augmenting-posting, reducing-posting).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">trade_map</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Transaction</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">posting</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">postings</span><span class="p">:</span>
            <span class="n">links_str</span> <span class="o">=</span> <span class="n">posting</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">META</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">links_str</span><span class="p">:</span>
                <span class="n">links</span> <span class="o">=</span> <span class="n">links_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
                    <span class="n">trade_map</span><span class="p">[</span><span class="n">link</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">posting</span><span class="p">))</span>

    <span class="c1"># Sort matches according to the index of the first entry, drop the index</span>
    <span class="c1"># used for doing this, and convert the objects to tuples..</span>
    <span class="n">trades</span> <span class="o">=</span> <span class="p">[(</span><span class="n">data</span><span class="o">.</span><span class="n">TxnPosting</span><span class="p">(</span><span class="n">augmenting</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">augmenting</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
               <span class="n">data</span><span class="o">.</span><span class="n">TxnPosting</span><span class="p">(</span><span class="n">reducing</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reducing</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
              <span class="k">for</span> <span class="n">augmenting</span><span class="p">,</span> <span class="n">reducing</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">trade_map</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>

    <span class="c1"># Sanity check.</span>
    <span class="k">for</span> <span class="n">matches</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">trades</span></div>


<div class="viewcode-block" id="book_price_conversions_plugin"><a class="viewcode-back" href="../../../modules/plugins/beancount.plugins.book_conversions.html#beancount.plugins.book_conversions.book_price_conversions_plugin">[docs]</a><span class="k">def</span> <span class="nf">book_price_conversions_plugin</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plugin that rewrites transactions to insert cost basis according to a booking method.</span>

<span class="sd">    See book_price_conversions() for details.</span>

<span class="sd">    Args:</span>
<span class="sd">      entries: A list of entry instances.</span>
<span class="sd">      options_map: A dict of options parsed from the file.</span>
<span class="sd">      config: A string, in &quot;&lt;ACCOUNT1&gt;,&lt;ACCOUNT2&gt;&quot; format.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A tuple of</span>
<span class="sd">        entries: A list of new, modified entries.</span>
<span class="sd">        errors: A list of errors generated by this plugin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The expected configuration is two account names, separated by whitespace.</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">assets_account</span><span class="p">,</span> <span class="n">income_account</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[,; \t]&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">account</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">assets_account</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">account</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">income_account</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid account string&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ConfigError</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="p">(</span><span class="s1">&#39;Invalid configuration: &quot;</span><span class="si">{}</span><span class="s1">&quot;: </span><span class="si">{}</span><span class="s1">, skipping booking&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">exc</span><span class="p">),</span>
                <span class="kc">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span>

    <span class="n">new_entries</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">book_price_conversions</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">assets_account</span><span class="p">,</span> <span class="n">income_account</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_entries</span><span class="p">,</span> <span class="n">errors</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../modules/plugins/beancount.plugins.book_conversions.html#beancount.plugins.book_conversions.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Extract trades from metadata-annotated postings and report on them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(levelname)-8s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Beancount input filename&#39;</span><span class="p">)</span>

    <span class="n">oparser</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Outputs&#39;</span><span class="p">)</span>
    <span class="n">oparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Filename to output results to (default goes to stdout)&quot;</span><span class="p">)</span>
    <span class="n">oparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--format&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span>
                         <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;csv&#39;</span><span class="p">],</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output format to render to (text, csv)&quot;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Load the input file.</span>
    <span class="n">entries</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">options_map</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Get the list of trades.</span>
    <span class="n">trades</span> <span class="o">=</span> <span class="n">extract_trades</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="c1"># Produce a table of all the trades.</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;units currency cost_currency &#39;</span>
               <span class="s1">&#39;buy_date buy_price sell_date sell_price pnl&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Units&#39;</span><span class="p">,</span> <span class="s1">&#39;Currency&#39;</span><span class="p">,</span> <span class="s1">&#39;Cost Currency&#39;</span><span class="p">,</span>
              <span class="s1">&#39;Buy Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Buy Price&#39;</span><span class="p">,</span> <span class="s1">&#39;Sell Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Sell Price&#39;</span><span class="p">,</span>
              <span class="s1">&#39;P/L&#39;</span><span class="p">]</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">aug</span><span class="p">,</span> <span class="n">red</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">:</span>
        <span class="n">units</span> <span class="o">=</span> <span class="o">-</span><span class="n">red</span><span class="o">.</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span>
        <span class="n">buy_price</span> <span class="o">=</span> <span class="n">aug</span><span class="o">.</span><span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">number</span>
        <span class="n">sell_price</span> <span class="o">=</span> <span class="n">red</span><span class="o">.</span><span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">number</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">units</span> <span class="o">*</span> <span class="p">(</span><span class="n">sell_price</span> <span class="o">-</span> <span class="n">buy_price</span><span class="p">))</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">buy_price</span><span class="p">)</span>
        <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
            <span class="o">-</span><span class="n">red</span><span class="o">.</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
            <span class="n">red</span><span class="o">.</span><span class="n">posting</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
            <span class="n">red</span><span class="o">.</span><span class="n">posting</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
            <span class="n">aug</span><span class="o">.</span><span class="n">txn</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">buy_price</span><span class="p">,</span>
            <span class="n">red</span><span class="o">.</span><span class="n">txn</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="n">sell_price</span><span class="p">,</span>
            <span class="n">pnl</span>
            <span class="p">])</span>
    <span class="n">trades_table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

    <span class="c1"># Render the table as text or CSV.</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="n">table</span><span class="o">.</span><span class="n">render_table</span><span class="p">(</span><span class="n">trades_table</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">format</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Beancount</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/index.html">Beancount Modules</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Martin Blais.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>